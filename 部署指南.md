# Bella Services 完整部署指南

## 📋 概述

本指南将指导你从零开始部署完整的 Bella Services，包括：
- **基础中间件**（MySQL、Redis、MinIO、Elasticsearch、Kafka）
- **Workflow 服务**（API + Web）
- **File API 服务**（API + Web）
- **共享 Nginx**（反向代理）

## 🛠️ 前置要求

### 系统要求
- **操作系统**: Linux/macOS/Windows（支持Docker）
- **内存**: 至少 8GB RAM
- **磁盘空间**: 至少 20GB 可用空间
- **端口**: 确保以下端口未被占用：
  - `80` (Nginx)
  - `3306` (MySQL)
  - `6379` (Redis)  
  - `9000` (MinIO)
  - `9200` (Elasticsearch)
  - `9092` (Kafka)

### 软件依赖
```bash
# 安装 Docker 和 Docker Compose
# Ubuntu/Debian
sudo apt update
sudo apt install docker.io docker-compose-plugin

# CentOS/RHEL
sudo yum install docker docker-compose-plugin

# macOS
brew install docker docker-compose

# 启动 Docker 服务
sudo systemctl start docker
sudo systemctl enable docker
```

## 🚀 部署步骤

### 步骤 1: 准备部署环境

```bash
# 1. 克隆或下载项目代码
cd /path/to/your/project

# 2. 确保脚本有执行权限
chmod +x deploy-middleware.sh
chmod +x deploy-all-services.sh
chmod +x prepare-mysql-init.sh
chmod +x set-tenant-apikey-infrastructure.sh

# 3. 检查目录结构
ls -la
# 应该看到: docker-compose.*.yml, deploy-*.sh, infrastructure/ 等
```

### 步骤 2: 配置环境变量

```bash
# 复制环境配置文件
cp .env.production .env

# 编辑环境配置（可选）
vim .env
```

**重要配置项说明：**
```bash
# 域名配置
WORKFLOW_DOMAIN=workflow.bella.top
KNOWLEDGE_DOMAIN=knowledge.bella.top

# 数据库密码
WORKFLOW_MYSQL_PASSWORD=bella123
FILE_API_MYSQL_PASSWORD=bella123
REDIS_PASSWORD=bella123

# S3 存储配置
WORKFLOW_S3_ACCESS_KEY=bella_admin
WORKFLOW_S3_SECRET_KEY=bella123456
```

### 步骤 3: 配置本地域名解析

```bash
# 编辑 hosts 文件
sudo vim /etc/hosts

# 添加以下内容
127.0.0.1 workflow.bella.top
127.0.0.1 knowledge.bella.top
```

### 步骤 4: 部署基础中间件

```bash
# 部署中间件（MySQL、Redis、MinIO、Elasticsearch、Kafka）
./deploy-middleware.sh

# 等待中间件启动完成（约2-3分钟）
# 检查中间件状态
docker compose -f docker-compose.infrastructure.yml ps
```

**预期输出：**
```
NAME                  STATUS
bella-elasticsearch   running
bella-kafka          running  
bella-minio          running
bella-mysql          running
bella-redis          running
```

### 步骤 5: 初始化数据库

```bash
# 设置 API Key（如果需要）
./set-tenant-apikey-infrastructure.sh

# 验证数据库连接
docker exec bella-mysql mysql -u root -pbella123 -e "SHOW DATABASES;"
```

**预期输出：**
```
+--------------------+
| Database           |
+--------------------+
| bella_file_api     |
| bella_workflow     |
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
```

### 步骤 6: 部署应用服务

```bash
# 一键部署所有服务（Workflow + File API + Nginx）
./deploy-all-services.sh

# 或者分步部署
# ./deploy-all-services.sh start --workflow-only
# ./deploy-all-services.sh start --file-api-only  
# ./deploy-all-services.sh start --nginx-only
```

**部署过程输出：**
```
🚀 开始部署 Bella Services...

[STEP] 检查部署前置条件...
[SUCCESS] 前置条件检查通过

[STEP] 创建必要的目录...
[SUCCESS] 目录创建完成

[STEP] 检查域名解析...
[INFO] 建议在 /etc/hosts 添加以下条目:
127.0.0.1 workflow.bella.top
127.0.0.1 knowledge.bella.top

[STEP] 启动Workflow服务...
[STEP] 启动File API服务...
[STEP] 等待应用服务启动...
[STEP] 启动共享Nginx...
[SUCCESS] 服务启动完成
```

### 步骤 7: 验证部署结果

```bash
# 检查所有服务状态
./deploy-all-services.sh status

# 检查容器运行状态  
docker ps

# 测试服务访问
curl -H "Host: workflow.bella.top" http://localhost/health
curl -H "Host: knowledge.bella.top" http://localhost/health
```

## 🔍 服务验证

### 访问地址
- **Workflow 服务**: http://workflow.bella.top
- **Knowledge 服务**: http://knowledge.bella.top
- **MinIO 管理界面**: http://localhost:9000 (bella_admin / bella123456)
- **Elasticsearch**: http://localhost:9200

### 健康检查
```bash
# Nginx 健康检查
curl http://localhost/health

# Workflow 域名检查
curl -H "Host: workflow.bella.top" http://localhost/health

# Knowledge 域名检查  
curl -H "Host: knowledge.bella.top" http://localhost/health

# API 健康检查
curl -H "Host: workflow.bella.top" http://localhost/api/health
curl -H "Host: knowledge.bella.top" http://localhost/api/health
```

## 🔧 常用管理命令

### 服务管理
```bash
# 查看服务状态
./deploy-all-services.sh status

# 查看服务日志
./deploy-all-services.sh logs

# 查看特定服务日志
./deploy-all-services.sh logs --workflow-only
./deploy-all-services.sh logs --file-api-only

# 重启服务
./deploy-all-services.sh restart

# 停止服务
./deploy-all-services.sh stop
```

### 中间件管理
```bash
# 重启中间件
./deploy-middleware.sh restart

# 停止中间件
./deploy-middleware.sh stop

# 查看中间件日志
docker compose -f docker-compose.infrastructure.yml logs -f
```

### Nginx 配置管理
```bash
# 重新加载 Nginx 配置
./deploy-all-services.sh nginx-reload

# 测试 Nginx 配置
docker exec bella-shared-nginx nginx -t

# 查看 Nginx 日志
docker logs bella-shared-nginx -f
```

## 📁 重要目录说明

```
├── infrastructure/          # 中间件配置
│   ├── mysql/init/         # 数据库初始化脚本
│   ├── minio/scripts/      # MinIO 初始化脚本  
│   └── kafka/scripts/      # Kafka 初始化脚本
├── shared-nginx/conf.d/    # Nginx 配置文件
├── workflow/api/           # Workflow 运行时数据
│   ├── logs/              # 日志文件
│   ├── cache/             # 缓存文件
│   └── privdata/          # 私有数据
└── file-api/api/          # File API 运行时数据
    ├── logs/              # 日志文件  
    ├── cache/             # 缓存文件
    └── privdata/          # 私有数据
```

## ⚠️ 故障排除

### 常见问题

#### 1. 端口冲突
```bash
# 检查端口占用
netstat -tlnp | grep :80
lsof -i :80

# 停止占用端口的服务
sudo systemctl stop apache2  # 如果有Apache
sudo systemctl stop nginx    # 如果有系统nginx
```

#### 2. 域名解析失败
```bash
# 确认 hosts 文件配置
cat /etc/hosts | grep bella

# 测试域名解析
nslookup workflow.bella.top
ping workflow.bella.top
```

#### 3. 服务启动失败
```bash
# 查看详细错误日志
docker compose -f docker-compose.workflow.yml logs
docker compose -f docker-compose.file-api.yml logs

# 检查容器状态
docker ps -a

# 重启单个容器
docker restart bella-workflow-api
```

#### 4. 数据库连接失败
```bash
# 检查数据库状态
docker exec bella-mysql mysql -u root -pbella123 -e "SELECT 1"

# 检查数据库用户
docker exec bella-mysql mysql -u root -pbella123 -e "SELECT User, Host FROM mysql.user"

# 重新初始化数据库
docker compose -f docker-compose.infrastructure.yml restart bella-mysql
```

#### 5. 内存不足
```bash
# 检查系统资源
free -h
df -h

# 清理 Docker 资源
docker system prune -a
```

### 日志文件位置
- **应用日志**: `./workflow/api/logs/` 和 `./file-api/api/logs/`
- **Nginx 日志**: `docker logs bella-shared-nginx`
- **数据库日志**: `docker logs bella-mysql`

## 🔄 备份和恢复

### 数据库备份
```bash
# 备份 Workflow 数据库
docker exec bella-mysql mysqldump -u root -pbella123 bella_workflow > workflow_backup.sql

# 备份 File API 数据库
docker exec bella-mysql mysqldump -u root -pbella123 bella_file_api > file_api_backup.sql
```

### 数据库恢复
```bash
# 恢复 Workflow 数据库
docker exec -i bella-mysql mysql -u root -pbella123 bella_workflow < workflow_backup.sql

# 恢复 File API 数据库  
docker exec -i bella-mysql mysql -u root -pbella123 bella_file_api < file_api_backup.sql
```

## 📞 支持

如果遇到问题，请检查：
1. **日志文件**：应用和容器日志
2. **系统资源**：内存、磁盘空间、端口
3. **网络连接**：域名解析、端口访问
4. **配置文件**：环境变量、Nginx配置

部署成功后，你将拥有一个完整的 Bella Services 环境！🎉