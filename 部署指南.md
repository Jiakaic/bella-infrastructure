# Bella Services å®Œæ•´éƒ¨ç½²æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—å°†æŒ‡å¯¼ä½ ä»é›¶å¼€å§‹éƒ¨ç½²å®Œæ•´çš„ Bella Servicesï¼ŒåŒ…æ‹¬ï¼š
- **åŸºç¡€ä¸­é—´ä»¶**ï¼ˆMySQLã€Redisã€MinIOã€Elasticsearchã€Kafkaï¼‰
- **Workflow æœåŠ¡**ï¼ˆAPI + Webï¼‰
- **File API æœåŠ¡**ï¼ˆAPI + Webï¼‰
- **å…±äº« Nginx**ï¼ˆåå‘ä»£ç†ï¼‰

## ğŸ› ï¸ å‰ç½®è¦æ±‚

### ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Linux/macOS/Windowsï¼ˆæ”¯æŒDockerï¼‰
- **å†…å­˜**: è‡³å°‘ 8GB RAM
- **ç£ç›˜ç©ºé—´**: è‡³å°‘ 20GB å¯ç”¨ç©ºé—´
- **ç«¯å£**: ç¡®ä¿ä»¥ä¸‹ç«¯å£æœªè¢«å ç”¨ï¼š
  - `80` (Nginx)
  - `3306` (MySQL)
  - `6379` (Redis)  
  - `9000` (MinIO)
  - `9200` (Elasticsearch)
  - `9092` (Kafka)

### è½¯ä»¶ä¾èµ–
```bash
# å®‰è£… Docker å’Œ Docker Compose
# Ubuntu/Debian
sudo apt update
sudo apt install docker.io docker-compose-plugin

# CentOS/RHEL
sudo yum install docker docker-compose-plugin

# macOS
brew install docker docker-compose

# å¯åŠ¨ Docker æœåŠ¡
sudo systemctl start docker
sudo systemctl enable docker
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1: å‡†å¤‡éƒ¨ç½²ç¯å¢ƒ

```bash
# 1. å…‹éš†æˆ–ä¸‹è½½é¡¹ç›®ä»£ç 
cd /path/to/your/project

# 2. ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
chmod +x deploy-middleware.sh
chmod +x deploy-all-services.sh
chmod +x prepare-mysql-init.sh
chmod +x set-tenant-apikey-infrastructure.sh

# 3. æ£€æŸ¥ç›®å½•ç»“æ„
ls -la
# åº”è¯¥çœ‹åˆ°: docker-compose.*.yml, deploy-*.sh, infrastructure/ ç­‰
```

### æ­¥éª¤ 2: é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶ç¯å¢ƒé…ç½®æ–‡ä»¶
cp .env.production .env

# ç¼–è¾‘ç¯å¢ƒé…ç½®ï¼ˆå¯é€‰ï¼‰
vim .env
```

**é‡è¦é…ç½®é¡¹è¯´æ˜ï¼š**
```bash
# åŸŸåé…ç½®
WORKFLOW_DOMAIN=workflow.bella.top
KNOWLEDGE_DOMAIN=knowledge.bella.top

# æ•°æ®åº“å¯†ç 
WORKFLOW_MYSQL_PASSWORD=bella123
FILE_API_MYSQL_PASSWORD=bella123
REDIS_PASSWORD=bella123

# S3 å­˜å‚¨é…ç½®
WORKFLOW_S3_ACCESS_KEY=bella_admin
WORKFLOW_S3_SECRET_KEY=bella123456
```

### æ­¥éª¤ 3: é…ç½®æœ¬åœ°åŸŸåè§£æ

```bash
# ç¼–è¾‘ hosts æ–‡ä»¶
sudo vim /etc/hosts

# æ·»åŠ ä»¥ä¸‹å†…å®¹
127.0.0.1 workflow.bella.top
127.0.0.1 knowledge.bella.top
```

### æ­¥éª¤ 4: éƒ¨ç½²åŸºç¡€ä¸­é—´ä»¶

```bash
# éƒ¨ç½²ä¸­é—´ä»¶ï¼ˆMySQLã€Redisã€MinIOã€Elasticsearchã€Kafkaï¼‰
./deploy-middleware.sh

# ç­‰å¾…ä¸­é—´ä»¶å¯åŠ¨å®Œæˆï¼ˆçº¦2-3åˆ†é’Ÿï¼‰
# æ£€æŸ¥ä¸­é—´ä»¶çŠ¶æ€
docker compose -f docker-compose.infrastructure.yml ps
```

**é¢„æœŸè¾“å‡ºï¼š**
```
NAME                  STATUS
bella-elasticsearch   running
bella-kafka          running  
bella-minio          running
bella-mysql          running
bella-redis          running
```

### æ­¥éª¤ 5: åˆå§‹åŒ–æ•°æ®åº“

```bash
# è®¾ç½® API Keyï¼ˆå¦‚æœéœ€è¦ï¼‰
./set-tenant-apikey-infrastructure.sh

# éªŒè¯æ•°æ®åº“è¿æ¥
docker exec bella-mysql mysql -u root -pbella123 -e "SHOW DATABASES;"
```

**é¢„æœŸè¾“å‡ºï¼š**
```
+--------------------+
| Database           |
+--------------------+
| bella_file_api     |
| bella_workflow     |
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
```

### æ­¥éª¤ 6: éƒ¨ç½²åº”ç”¨æœåŠ¡

```bash
# ä¸€é”®éƒ¨ç½²æ‰€æœ‰æœåŠ¡ï¼ˆWorkflow + File API + Nginxï¼‰
./deploy-all-services.sh

# æˆ–è€…åˆ†æ­¥éƒ¨ç½²
# ./deploy-all-services.sh start --workflow-only
# ./deploy-all-services.sh start --file-api-only  
# ./deploy-all-services.sh start --nginx-only
```

**éƒ¨ç½²è¿‡ç¨‹è¾“å‡ºï¼š**
```
ğŸš€ å¼€å§‹éƒ¨ç½² Bella Services...

[STEP] æ£€æŸ¥éƒ¨ç½²å‰ç½®æ¡ä»¶...
[SUCCESS] å‰ç½®æ¡ä»¶æ£€æŸ¥é€šè¿‡

[STEP] åˆ›å»ºå¿…è¦çš„ç›®å½•...
[SUCCESS] ç›®å½•åˆ›å»ºå®Œæˆ

[STEP] æ£€æŸ¥åŸŸåè§£æ...
[INFO] å»ºè®®åœ¨ /etc/hosts æ·»åŠ ä»¥ä¸‹æ¡ç›®:
127.0.0.1 workflow.bella.top
127.0.0.1 knowledge.bella.top

[STEP] å¯åŠ¨WorkflowæœåŠ¡...
[STEP] å¯åŠ¨File APIæœåŠ¡...
[STEP] ç­‰å¾…åº”ç”¨æœåŠ¡å¯åŠ¨...
[STEP] å¯åŠ¨å…±äº«Nginx...
[SUCCESS] æœåŠ¡å¯åŠ¨å®Œæˆ
```

### æ­¥éª¤ 7: éªŒè¯éƒ¨ç½²ç»“æœ

```bash
# æ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€
./deploy-all-services.sh status

# æ£€æŸ¥å®¹å™¨è¿è¡ŒçŠ¶æ€  
docker ps

# æµ‹è¯•æœåŠ¡è®¿é—®
curl -H "Host: workflow.bella.top" http://localhost/health
curl -H "Host: knowledge.bella.top" http://localhost/health
```

## ğŸ” æœåŠ¡éªŒè¯

### è®¿é—®åœ°å€
- **Workflow æœåŠ¡**: http://workflow.bella.top
- **Knowledge æœåŠ¡**: http://knowledge.bella.top
- **MinIO ç®¡ç†ç•Œé¢**: http://localhost:9000 (bella_admin / bella123456)
- **Elasticsearch**: http://localhost:9200

### å¥åº·æ£€æŸ¥
```bash
# Nginx å¥åº·æ£€æŸ¥
curl http://localhost/health

# Workflow åŸŸåæ£€æŸ¥
curl -H "Host: workflow.bella.top" http://localhost/health

# Knowledge åŸŸåæ£€æŸ¥  
curl -H "Host: knowledge.bella.top" http://localhost/health

# API å¥åº·æ£€æŸ¥
curl -H "Host: workflow.bella.top" http://localhost/api/health
curl -H "Host: knowledge.bella.top" http://localhost/api/health
```

## ğŸ”§ å¸¸ç”¨ç®¡ç†å‘½ä»¤

### æœåŠ¡ç®¡ç†
```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
./deploy-all-services.sh status

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
./deploy-all-services.sh logs

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
./deploy-all-services.sh logs --workflow-only
./deploy-all-services.sh logs --file-api-only

# é‡å¯æœåŠ¡
./deploy-all-services.sh restart

# åœæ­¢æœåŠ¡
./deploy-all-services.sh stop
```

### ä¸­é—´ä»¶ç®¡ç†
```bash
# é‡å¯ä¸­é—´ä»¶
./deploy-middleware.sh restart

# åœæ­¢ä¸­é—´ä»¶
./deploy-middleware.sh stop

# æŸ¥çœ‹ä¸­é—´ä»¶æ—¥å¿—
docker compose -f docker-compose.infrastructure.yml logs -f
```

### Nginx é…ç½®ç®¡ç†
```bash
# é‡æ–°åŠ è½½ Nginx é…ç½®
./deploy-all-services.sh nginx-reload

# æµ‹è¯• Nginx é…ç½®
docker exec bella-shared-nginx nginx -t

# æŸ¥çœ‹ Nginx æ—¥å¿—
docker logs bella-shared-nginx -f
```

## ğŸ“ é‡è¦ç›®å½•è¯´æ˜

```
â”œâ”€â”€ infrastructure/          # ä¸­é—´ä»¶é…ç½®
â”‚   â”œâ”€â”€ mysql/init/         # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”‚   â”œâ”€â”€ minio/scripts/      # MinIO åˆå§‹åŒ–è„šæœ¬  
â”‚   â””â”€â”€ kafka/scripts/      # Kafka åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ shared-nginx/conf.d/    # Nginx é…ç½®æ–‡ä»¶
â”œâ”€â”€ workflow/api/           # Workflow è¿è¡Œæ—¶æ•°æ®
â”‚   â”œâ”€â”€ logs/              # æ—¥å¿—æ–‡ä»¶
â”‚   â”œâ”€â”€ cache/             # ç¼“å­˜æ–‡ä»¶
â”‚   â””â”€â”€ privdata/          # ç§æœ‰æ•°æ®
â””â”€â”€ file-api/api/          # File API è¿è¡Œæ—¶æ•°æ®
    â”œâ”€â”€ logs/              # æ—¥å¿—æ–‡ä»¶  
    â”œâ”€â”€ cache/             # ç¼“å­˜æ–‡ä»¶
    â””â”€â”€ privdata/          # ç§æœ‰æ•°æ®
```

## âš ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. ç«¯å£å†²çª
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep :80
lsof -i :80

# åœæ­¢å ç”¨ç«¯å£çš„æœåŠ¡
sudo systemctl stop apache2  # å¦‚æœæœ‰Apache
sudo systemctl stop nginx    # å¦‚æœæœ‰ç³»ç»Ÿnginx
```

#### 2. åŸŸåè§£æå¤±è´¥
```bash
# ç¡®è®¤ hosts æ–‡ä»¶é…ç½®
cat /etc/hosts | grep bella

# æµ‹è¯•åŸŸåè§£æ
nslookup workflow.bella.top
ping workflow.bella.top
```

#### 3. æœåŠ¡å¯åŠ¨å¤±è´¥
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
docker compose -f docker-compose.workflow.yml logs
docker compose -f docker-compose.file-api.yml logs

# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps -a

# é‡å¯å•ä¸ªå®¹å™¨
docker restart bella-workflow-api
```

#### 4. æ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
docker exec bella-mysql mysql -u root -pbella123 -e "SELECT 1"

# æ£€æŸ¥æ•°æ®åº“ç”¨æˆ·
docker exec bella-mysql mysql -u root -pbella123 -e "SELECT User, Host FROM mysql.user"

# é‡æ–°åˆå§‹åŒ–æ•°æ®åº“
docker compose -f docker-compose.infrastructure.yml restart bella-mysql
```

#### 5. å†…å­˜ä¸è¶³
```bash
# æ£€æŸ¥ç³»ç»Ÿèµ„æº
free -h
df -h

# æ¸…ç† Docker èµ„æº
docker system prune -a
```

### æ—¥å¿—æ–‡ä»¶ä½ç½®
- **åº”ç”¨æ—¥å¿—**: `./workflow/api/logs/` å’Œ `./file-api/api/logs/`
- **Nginx æ—¥å¿—**: `docker logs bella-shared-nginx`
- **æ•°æ®åº“æ—¥å¿—**: `docker logs bella-mysql`

## ğŸ”„ å¤‡ä»½å’Œæ¢å¤

### æ•°æ®åº“å¤‡ä»½
```bash
# å¤‡ä»½ Workflow æ•°æ®åº“
docker exec bella-mysql mysqldump -u root -pbella123 bella_workflow > workflow_backup.sql

# å¤‡ä»½ File API æ•°æ®åº“
docker exec bella-mysql mysqldump -u root -pbella123 bella_file_api > file_api_backup.sql
```

### æ•°æ®åº“æ¢å¤
```bash
# æ¢å¤ Workflow æ•°æ®åº“
docker exec -i bella-mysql mysql -u root -pbella123 bella_workflow < workflow_backup.sql

# æ¢å¤ File API æ•°æ®åº“  
docker exec -i bella-mysql mysql -u root -pbella123 bella_file_api < file_api_backup.sql
```

## ğŸ“ æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. **æ—¥å¿—æ–‡ä»¶**ï¼šåº”ç”¨å’Œå®¹å™¨æ—¥å¿—
2. **ç³»ç»Ÿèµ„æº**ï¼šå†…å­˜ã€ç£ç›˜ç©ºé—´ã€ç«¯å£
3. **ç½‘ç»œè¿æ¥**ï¼šåŸŸåè§£æã€ç«¯å£è®¿é—®
4. **é…ç½®æ–‡ä»¶**ï¼šç¯å¢ƒå˜é‡ã€Nginxé…ç½®

éƒ¨ç½²æˆåŠŸåï¼Œä½ å°†æ‹¥æœ‰ä¸€ä¸ªå®Œæ•´çš„ Bella Services ç¯å¢ƒï¼ğŸ‰